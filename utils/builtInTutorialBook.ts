import { Book, Chapter } from '../types';

export const BUILT_IN_TUTORIAL_BOOK_ID = '__built_in_tutorial__';
/** Bump this number whenever tutorial content is changed so existing users get the update. */
export const BUILT_IN_TUTORIAL_VERSION = 2.0;

const TUTORIAL_UNREAD_KEY = '__built_in_tutorial_unread__';
export const isTutorialUnread = (): boolean => {
  try { return localStorage.getItem(TUTORIAL_UNREAD_KEY) === '1'; } catch { return false; }
};
export const markTutorialUnread = (): void => {
  try { localStorage.setItem(TUTORIAL_UNREAD_KEY, '1'); } catch { /* no-op */ }
};
export const clearTutorialUnread = (): void => {
  try { localStorage.removeItem(TUTORIAL_UNREAD_KEY); } catch { /* no-op */ }
};

export const isBuiltInBook = (bookId: string) => bookId === BUILT_IN_TUTORIAL_BOOK_ID;

const TUTORIAL_CHAPTERS: Chapter[] = [
  {
    title: '第一章 快速开始',
    content: `这是一个让角色陪你一起阅读的工具。你可以导入自己的书籍，在阅读的同时和一个角色聊你正在读的内容——角色会感知你读到哪里，结合正文和你交流。

只需要三步就可以开始：

第一步：配置接口
点击底部导航栏最右侧的"设置"图标，进入设置页面。选择"API配置"，在里面填入你的接口地址、API密钥和模型名称。目前支持 OpenAI、DeepSeek、Google Gemini、Anthropic Claude，以及任何兼容 OpenAI 格式的自定义接口。填完之后可以点"测试连接"确认是否正常。

第二步：导入书籍
回到书架页面，点击右下角的"+"按钮。你可以直接上传文件（支持拖拽），也可以粘贴一个下载链接，或者手动输入文本内容。支持的文件格式包括 TXT、PDF、EPUB 和 DOCX。

第三步：开始阅读
导入完成后，点击书籍封面就能进入阅读界面。上方是正文区域，下方是和角色的对话区域。角色会根据你当前阅读的内容和你交流。

以上就是最基本的使用流程。如果你想了解更多功能，后面的章节会逐一介绍每个板块的详细用法。`,
  },
  {
    title: '第二章 书架',
    content: `书架是你管理所有书籍的地方。

导入书籍
点击右下角的"+"按钮可以导入新书。有三种方式：
· 上传文件：点击上传区域选择文件，或者直接将文件拖拽到上传区域。支持 TXT、PDF、EPUB、DOCX 格式。
· 网址导入：切换到链接模式，粘贴文件的下载链接，系统会自动获取并解析。
· 手动输入：直接在文本框中粘贴书籍内容。

导入时可以填写书籍的标题、作者，添加标签，以及设置封面图片。

编辑书籍信息
每本书的卡片上有一个编辑按钮（铅笔图标），点击后可以修改：
· 标题和作者
· 封面图片（支持上传图片、粘贴图片链接，或使用接口生成封面）
· 标签（用于分类和筛选）
· 章节正则表达式（用于自动识别章节结构）
· 结构化章节模式（手动定义每个章节的标题和内容）

章节解析
如果你的书没有被正确分章，可以在编辑界面填写章节正则表达式。比如填入"第.+章"就能匹配"第一章""第二章"这样的标题。系统会实时显示识别到的章节数量。你也可以点击旁边的按钮让接口帮你自动生成正则表达式。如果想更精细地控制，可以切换到结构化章节模式，手动拆分每个章节。

RAG 智能检索
在编辑界面底部有一个"RAG索引"开关。开启后，系统会为这本书建立向量索引，让角色在对话时能检索全书中最相关的段落，而不仅限于你当前阅读位置附近的文字。适合内容量大、需要跨章节关联的书籍。

搜索与筛选
书架顶部有搜索框，可以按书名或作者搜索。旁边的筛选按钮可以按标签过滤。排序支持按标题、作者、阅读进度、添加时间和书本长度排列，可以切换升序或降序。

视图切换
书架支持两种视图：
· 网格视图：以封面卡片形式展示，更直观。
· 列表视图：紧凑的文字列表，信息密度更高。

切换按钮在排序按钮旁边，你的偏好会被记住。

人设与角色切换
书架左上角显示你当前的用户头像和签名。点击头像可以快速切换当前使用的人设和角色，不需要进入设置页面。`,
  },
  {
    title: '第三章 阅读界面',
    content: `点击书架中的书籍就会进入阅读界面。界面分为上方的正文阅读区和下方的对话区，对话区的高度可以拖拽调整。

正文阅读区

左上角的菜单按钮会展开一个侧边面板，包含以下功能：

目录
列出书中所有章节。当前章节会高亮显示，点击任意章节标题可以直接跳转过去。

书签
你可以在当前阅读位置创建书签，给它取一个名字（最多40个字符）。之后在书签列表中点击就能跳回那个位置。不需要的书签可以随时删除。

高亮标注
在正文中选中一段文字后，会出现颜色选择面板。选择一个颜色就能给这段文字添加高亮标记。预设了黄、橙、红、绿、蓝、紫六种颜色，也可以自定义颜色。每个章节的高亮是独立保存的，可以单独清除。

排版设置
可以调整以下选项：
· 字体：预设了宋体、黑体、等宽三种字体，也支持通过 CSS 链接或字体文件导入自定义字体。
· 字号：可以调大或调小。
· 行高：有 1.4、1.6、1.8、2.0 四档可选。
· 文字颜色和背景色：提供多种预设配色，也可以自定义。
· 对齐方式：居左、居中、两端对齐。

章节切换
正文底部有"上一章"和"下一章"按钮。阅读位置会自动记录，下次打开同一本书会回到上次的位置。

进度追踪
阅读界面会实时记录你的进度百分比。每次翻页、切换章节都会更新。这些数据也会体现在书架的进度条和统计页面中。

对话区

对话区是你和角色交流的地方。角色会根据你当前阅读到的正文内容来回应你。

你可以直接在输入框中打字发送消息。角色的回复会以多个气泡的形式展示，而不是一大段文字堆在一起。

如果你选中了正文中的某段文字再发送消息，角色会看到你引用的内容，方便针对性地讨论。`,
  },
  {
    title: '第四章 角色互动详解',
    content: `角色不只是被动地回答你的问题，它可以主动参与到你的阅读过程中。

主动评论
在设置中开启"主动评论"后，角色会在你阅读的过程中不时发表评论。你可以调节两个参数：
· 评论概率（0-100%）：每次触发时角色实际发言的概率。
· 评论间隔（10-600秒）：两次触发之间的最短等待时间。
比如设置50%概率、30秒间隔，意味着每隔30秒有一半的机会角色会主动说一句。

智能划线
开启"智能划线"后，角色会在它认为重要的段落下方添加下划线标记。这些标记和你手动添加的高亮是不同的，可以单独管理。每次生成的划线有一个编号，如果你觉得某次划线不合适，可以按编号撤回。

上下文感知
角色能感知你当前阅读到的位置，系统会把你附近的正文内容作为上下文发送给角色。默认提供当前位置前后约800个字符的内容，这个范围可以在对话面板的进阶设置中调整。

如果你为书籍开启了 RAG 索引，角色还能检索全书中最相关的段落作为补充上下文，不仅限于当前位置附近的文字。

记忆管理
对话历史默认保留最近100条消息作为角色的记忆。超过这个数量的旧消息会从角色的上下文中移除，但对话记录本身不会消失，你仍然可以往上滚动查看。这个数量可以在对话面板的进阶设置中调整。

自动总结
系统可以在聊天消息达到一定数量时自动生成对话总结，以及在阅读进度达到一定字数时自动生成书本阅读总结。这些功能默认关闭，可以在对话面板的进阶设置中开启并配置触发条件。

回复风格
角色每次回复会生成多个气泡，而不是一整段。默认最少3个、最多8个气泡。这个范围可以调整，影响角色单次回复的长度和节奏感。

对话存档
如果一段对话你觉得有参考价值，可以将它存档到共读集的笔记本中，方便日后回顾。`,
  },
  {
    title: '第五章 共读集',
    content: `共读集是阅读之外的学习工具，点击底部导航栏的灯泡图标进入。它包含两个板块：笔记本和内容问答。

笔记本

笔记本用来记录和整理你的读书心得。

创建笔记本时需要填写标题，并绑定一本或多本书。你还可以为笔记本设置封面和纸张背景纹理。每个笔记本可以绑定一个人设，决定后续角色评论时使用的身份。

在笔记本中，你可以创建多条笔记。每条笔记就是一段你的文字——可以是摘抄、感悟、问题，任何你想记下来的东西。

角色评论
笔记写好之后，点击"评论"按钮可以让角色对你的笔记进行点评。你可以选择最多3个角色来评论同一条笔记。角色会基于笔记内容和绑定书籍的上下文来给出评价。

评论以对话的形式呈现，你可以回复角色的评论，形成进一步的讨论。每条笔记的评论是独立的。

内容问答

内容问答是一个基于书籍内容的测验工具。

创建测验时需要配置：
· 选择书籍：从你的书架中选择一本或多本书作为出题范围。
· 题目数量：你想答多少道题。
· 题目类型：单选题、多选题或判断题。
· 选项数量：每道题有几个选项。
· 自定义提示：可以给出题方向加一些额外的指引，比如"侧重第三章的内容"。

配置好之后，角色会根据选定书籍的内容生成测验题。答题界面支持左右滑动切换题目。

答完所有题目后会显示得分和角色对你表现的总评。测验记录会保存下来，你可以在历史列表中随时回顾。`,
  },
  {
    title: '第六章 统计',
    content: `统计页面展示你的阅读数据，点击底部导航栏的饼图图标进入。

概览卡片
页面顶部有四张概览卡片：
· 连续天数：你连续阅读的天数。
· 阅读时长：累计阅读的总小时数。
· 已完成：阅读进度达到100%的书籍数量。
· 阅读目标：你设定的年度阅读目标，以及当前完成的数量。

阅读日历
一张52周的热力图，展示过去一年的阅读活跃度。每个小格代表一天，颜色深浅表示当天的阅读时长：
· 无色：当天没有阅读。
· 浅色：阅读不足2小时。
· 中等：阅读2-5小时。
· 深色：阅读超过5小时。
颜色基于你设置的主题色生成。

每周阅读图表
一张柱状图，展示本周每天的阅读时长。横轴是周一到周日，纵轴是小时数。直观地看出你一周的阅读节奏。

角色便签
角色会给你留小纸条。这些便签内容是基于你的阅读情况生成的，可能是鼓励、提醒，或者简单的问候。你可以回复便签，和角色互动。便签内容会缓存，不会每次打开都重新生成。`,
  },
  {
    title: '第七章 设置',
    content: `设置页面包含多个子板块，点击底部导航栏最右侧的齿轮图标进入。

外观
· 深色模式：切换浅色和深色主题。浅色模式使用新拟态风格，深色模式使用深色调。
· 主题色：选择一个颜色作为全局强调色，会影响按钮、进度条、标签等元素的配色。默认是玫瑰色。
· 字号缩放：全局调整界面文字大小，范围0.8倍到1.2倍。不影响阅读正文的字号（正文字号在阅读界面单独设置）。
· 安全区域：如果你的设备有刘海屏或药丸屏，可以设置顶部和底部的安全间距，避免内容被遮挡。

API配置
这里是连接语言模型的地方。

主接口配置：
· 选择提供商：OpenAI、DeepSeek、Google Gemini、Anthropic Claude，或自定义接口。
· 填入接口地址（Endpoint）、API密钥（Key）和模型名称（Model）。
· 点击"测试连接"可以验证配置是否正常。

接口预设：
你可以保存多套配置作为预设，方便在不同的模型之间切换。比如一套用来日常阅读，一套用更强的模型来做问答。

RAG预设：
如果你使用了 RAG 智能检索功能，可以在这里为 RAG 配置独立的模型接口。RAG 对模型要求不同，有时候用一个更快的模型就够了。

人设管理
人设是你在这个APP中的身份。每个人设包含：
· 头像：上传图片或粘贴链接。
· 名称和昵称：名称是全名，昵称是在对话中显示的称呼。
· 描述：你的性格、背景等信息，角色在对话时会参考这些内容来调整回应方式。

你可以创建多个人设，在不同的阅读场景下使用不同的身份。

角色管理
角色是陪你阅读的伙伴。每个角色包含：
· 头像：角色的形象。
· 名称和昵称：和人设类似。
· 性格描述：这是最重要的部分，决定了角色说话的风格、态度和行为方式。写得越具体，角色表现越贴合你的期望。

你可以创建多个角色并随时切换。不同的书可以搭配不同的角色。

世界书
世界书是角色的知识库。你可以在里面创建条目，为角色补充背景知识。

条目按分类组织，你可以创建和管理不同的分类。每个条目包含：
· 标题：简短的标识。
· 内容：具体的知识描述。
· 插入位置：控制这个条目在角色上下文中的优先级。

条目支持拖拽排序。角色在对话时会参考世界书中的条目，让它的回应更有知识深度和一致性。

存储管理
这里展示APP所有数据的存储占用，以环形图的形式展示各类数据的比例：文本信息、聊天记录、共读集、世界书、人设角色、美化预设、统计数据等。

你可以在这里：
· 导出存档：将所有数据打包导出为一个文件，用于备份或迁移。
· 导入存档：从之前导出的文件恢复数据。
· 清空数据：清除所有APP数据（请谨慎操作）。

AI行为
控制角色在阅读时的主动行为：
· 主动评论：开关、触发概率（0-100%）、触发间隔（10-600秒）。
· 智能划线：开关、触发概率（0-100%）。`,
  },
  {
    title: '第八章 进阶技巧',
    content: `这一章汇总一些能提升使用体验的技巧和建议。

打造你的阅读环境
· 在阅读界面的排版设置中，花几分钟调整字体、字号、行高和配色，找到最舒适的阅读体验。
· 如果你习惯夜间阅读，开启深色模式并选择较暗的正文背景色。
· 全局字号缩放和正文字号是独立的。全局缩放影响界面元素，正文字号只影响阅读区。

让角色更懂你
角色的表现取决于几个要素：
· 角色描述：越具体越好。不要只写"你是一个温柔的角色"，而是详细描述它的说话习惯、会用什么语气、对什么话题感兴趣、会不会主动提问等。
· 世界书条目：如果你希望角色了解特定的背景知识，把它写进世界书。比如角色需要了解的术语解释、人物关系、世界观设定等。
· 人设描述：你自己的人设也会影响角色的回应方式。角色会根据你的描述来调整称呼和语气。

对话面板进阶设置
在阅读界面的对话区，右上角的菜单按钮可以打开进阶设置。这些设置影响对话体验的细节：

外观类：
· 气泡字号缩放：单独调整对话区文字大小。
· 聊天背景图：为对话区设置一张自定义背景图片。
· 消息时间戳：显示或隐藏每条消息的发送时间。
· CSS样式自定义：自定义整个消息界面的外观，内置了多种预设，也可以自己写CSS。以下是所有支持自定义的类名及其对应的元素：
  .rm-panel —— 消息面板整体容器
  .rm-header —— 顶部区域（头像和角色名所在的栏）
  .rm-avatar —— 角色头像
  .rm-char-name —— 角色名字
  .rm-messages —— 消息列表滚动区域
  .rm-bubble —— 所有消息气泡的通用类
  .rm-bubble-ai —— 角色发送的气泡
  .rm-bubble-user —— 你发送的气泡
  .rm-time-tag —— 消息之间的居中时间分隔标签（间隔较长时显示）
  .rm-msg-time —— 每条消息上方的时间戳（开启"显示消息时间"后可见）
  .rm-input-area —— 底部输入区整体
  .rm-input-wrap —— 输入框外层容器（圆角边框）
  .rm-input —— 文本输入框本身
  .rm-send-btn —— 发送按钮
  .rm-retry-btn —— 重试按钮
  .rm-typing —— 正在输入提示整体
  .rm-typing-name —— 提示中的角色名
  .rm-typing-text —— 提示中的文字部分（如"正在输入中..."），可通过 CSS 隐藏原文并用伪元素替换显示内容
  在深色模式下，可以用 .dark-mode 前缀来编写针对深色主题的样式，例如 .dark-mode .rm-panel { ... }。

功能类：
· 阅读摘录字符数：控制发送给角色的正文上下文范围。默认800字符，增大可以让角色看到更多前后文，但会消耗更多 Token。
· 记忆气泡数量：角色能记住的历史消息条数。默认100条。
· 回复气泡范围：角色单次回复的气泡数量范围（默认3-8个）。
· 自动聊天总结：开启后，当对话消息达到设定数量时自动生成一段摘要。
· 自动书本总结：开启后，当阅读推进到设定字数时自动生成阅读总结。
· 独立总结API：可以为总结功能配置一个单独的模型接口，避免和主对话抢资源。

善用 RAG 智能检索
对于内容量大的书籍（比如长篇小说、教材），开启 RAG 索引后角色的回应质量会明显提升。它能在全书范围内找到和当前话题最相关的段落，而不仅仅依赖你当前阅读位置附近的文字。

索引建立需要一点时间，建立完成后会自动生效。你可以在书籍编辑界面开启这个功能，并选择用哪个 RAG 预设模型来构建索引。

养成备份习惯
你的所有数据（书籍、聊天记录、笔记、设置等）都存储在浏览器本地。如果清除浏览器数据或更换设备，这些内容会丢失。建议定期在设置的"存储管理"中导出一份存档文件，以防万一。`,
  },
];

/** 计算全书纯文本总长度 */
const computeFullTextLength = (chapters: Chapter[]): number =>
  chapters.reduce((sum, ch) => sum + ch.content.length, 0);

/** 将所有章节内容拼接为 fullText（以换行分隔） */
const computeFullText = (chapters: Chapter[]): string =>
  chapters.map((ch) => `${ch.title}\n\n${ch.content}`).join('\n\n');

export function createBuiltInTutorialBook(): Book {
  const fullText = computeFullText(TUTORIAL_CHAPTERS);
  return {
    id: BUILT_IN_TUTORIAL_BOOK_ID,
    title: '教程',
    author: 'whitedry',
    coverUrl: '',
    progress: 0,
    lastRead: '',
    tags: ['内置'],
    fullText,
    chapters: TUTORIAL_CHAPTERS,
    fullTextLength: fullText.length,
    chapterCount: TUTORIAL_CHAPTERS.length,
  };
}
