import { ReaderCssPreset } from '../types';

export const DEFAULT_NEUMORPHISM_BUBBLE_CSS_PRESET_ID = 'builtin-default-neumorphism-v1';
export const STARRY_DEEP_BLUE_CSS_PRESET_ID = 'builtin-starry-deep-blue-v1';

const REMOVED_PRESET_IDS = new Set<string>([
  'builtin-retro-snow-v1',
  'builtin-glass-morphism-v1',
]);

const REMOVED_PRESET_NAMES = new Set<string>([
  '雪笺旧梦',
  '雪笺旧梦（旧版）',
  '玻璃拟态',
  '复古',
  '复古雪笺',
]);

export const LEGACY_DEFAULT_NEUMORPHISM_BUBBLE_CSS = [
  '/* Default neumorphism bubble style */',
  '.rm-bubble {',
  '  border-style: solid;',
  '  transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;',
  '}',
  '',
  '.rm-bubble-ai {',
  '  background: #e0e5ec;',
  '  color: #334155;',
  '  border-color: rgba(148, 163, 184, 0.35);',
  '  box-shadow: 5px 5px 10px #c3c8ce, -5px -5px 10px #fdffff;',
  '}',
  '',
  '.rm-bubble-user {',
  '  background: #fb7185;',
  '  color: #ffffff;',
  '  border-color: rgba(255, 255, 255, 0.24);',
  '  box-shadow: 5px 5px 10px rgba(209, 213, 219, 0.9), -5px -5px 10px rgba(255, 255, 255, 0.96);',
  '}',
  '',
  '.dark-mode .rm-bubble-ai {',
  '  background: #1a202c;',
  '  color: #cbd5e1;',
  '  border-color: rgba(148, 163, 184, 0.2);',
  '  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.38);',
  '}',
  '',
  '.dark-mode .rm-bubble-user {',
  '  background: #f43f5e;',
  '  color: #ffffff;',
  '  border-color: rgba(255, 255, 255, 0.18);',
  '  box-shadow: 0 8px 16px rgba(244, 63, 94, 0.28);',
  '}',
].join('\n');

export const DEFAULT_NEUMORPHISM_BUBBLE_CSS = [
  '/* Default neumorphism bubble style */',
  '.rm-bubble {',
  '  border: none;',
  '  transition: background 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;',
  '}',
  '',
  '.rm-bubble-ai {',
  '  background: #e0e5ec;',
  '  color: #334155;',
  '  box-shadow: 5px 5px 10px #c3c8ce, -5px -5px 10px #fdffff;',
  '}',
  '',
  '.rm-bubble-user {',
  '  background: rgb(var(--theme-400) / 1);',
  '  color: #ffffff;',
  '  box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.34), -5px -5px 10px rgba(255, 255, 255, 0.84);',
  '}',
  '',
  '.dark-mode .rm-bubble-ai {',
  '  background: #1a202c;',
  '  color: #cbd5e1;',
  '  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.38);',
  '}',
  '',
  '.dark-mode .rm-bubble-user {',
  '  background: rgb(var(--theme-500) / 1);',
  '  color: #ffffff;',
  '  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.38), inset 0 1px 0 rgb(var(--theme-300) / 0.16);',
  '}',
].join('\n');

const STARRY_DEEP_BLUE_CSS = [
  '/* ✦ 星辰深蓝 — 亮暗双模式 (菱形钻石主题) ✦ */',
  '',
  '@import url("https://fontsapi.zeoseven.com/441/main/result.css");',
  '',
  '/* 1. 引入字体仅替换消息界面内所有字体 */',
  '.rm-panel,',
  '.rm-panel * {',
  '    font-family: "JiangChengJieXingTi", sans-serif !important;',
  '}',
  '',
  '/* ═══ 动画板块 ═══ */',
  '@keyframes twinkle-1 {',
  '  0%, 100% { opacity: 0.15; }',
  '  50% { opacity: 1; }',
  '}',
  '@keyframes twinkle-2 {',
  '  0%, 100% { opacity: 0.8; }',
  '  50% { opacity: 0.1; }',
  '}',
  '@keyframes breathe-star {',
  '  0%, 100% { opacity: 0.3; transform: scale(0.6) rotate(0deg); }',
  '  50% { opacity: 1; transform: scale(1.1) rotate(15deg); }',
  '}',
  '@keyframes float-drift {',
  '  0%, 100% { transform: translateY(0); }',
  '  50% { transform: translateY(-3px); }',
  '}',
  '@keyframes glow-pulse-dark {',
  '  0%, 100% { filter: drop-shadow(0 0 12px rgba(100, 160, 255, 0.8)); }',
  '  50% { filter: drop-shadow(0 0 20px rgba(100, 160, 255, 1)) drop-shadow(0 0 35px rgba(60, 120, 255, 0.8)); }',
  '}',
  '@keyframes glow-pulse-light {',
  '  0%, 100% { filter: drop-shadow(0 0 10px rgba(80, 140, 220, 0.7)); }',
  '  50% { filter: drop-shadow(0 0 18px rgba(80, 140, 220, 0.9)) drop-shadow(0 0 30px rgba(50, 100, 200, 0.6)); }',
  '}',
  '@keyframes input-glow-light {',
  '  0%, 100% { filter: drop-shadow(0 0 3px rgba(80, 140, 220, 0.25)); }',
  '  50% { filter: drop-shadow(0 0 8px rgba(80, 140, 220, 0.45)); }',
  '}',
  '@keyframes input-glow-dark {',
  '  0%, 100% { filter: drop-shadow(0 0 4px rgba(100, 160, 255, 0.3)); }',
  '  50% { filter: drop-shadow(0 0 10px rgba(100, 160, 255, 0.55)); }',
  '}',
  '',
  '',
  '/* ══════════════════════════════',
  '   亮色模式（默认）板块',
  '   ══════════════════════════════ */',
  '',
  '.rm-panel {',
  '  position: relative;',
  '  overflow: hidden;',
  '  background: linear-gradient(170deg, #e6f0fa 0%, #dbe8f5 40%, #cddceb 100%);',
  '  border-top: 1px solid rgba(80, 140, 220, 0.15);',
  '}',
  '',
  '.rm-header {',
  '  border-bottom: 1px solid rgba(80, 140, 220, 0.1);',
  '  min-height: 80px !important;',
  '  padding-top: 15px !important;',
  '  padding-bottom: 15px !important;',
  '  position: relative; z-index: 10;',
  '}',
  '',
  '/* 角色头像：外层容器负责发光，不裁切 */',
  '.rm-avatar {',
  '  width: 60px !important;',
  '  height: 60px !important;',
  '  border-radius: 0 !important;',
  '  border: none !important;',
  '  overflow: visible !important;',
  '  background: transparent !important;',
  '  box-shadow: none !important;',
  '  filter: drop-shadow(0 0 10px rgba(80, 140, 220, 0.8));',
  '  animation: glow-pulse-light 3s ease-in-out infinite;',
  '}',
  '/* 菱形裁切只作用于内部图片/子元素 */',
  '.rm-avatar > * {',
  '  clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);',
  '  width: 100% !important;',
  '  height: 100% !important;',
  '  border-radius: 0 !important;',
  '}',
  '',
  '.rm-char-name {',
  '  background: linear-gradient(90deg, #4a8bc2, #5cb8b2);',
  '  -webkit-background-clip: text;',
  '  -webkit-text-fill-color: transparent;',
  '  font-weight: 800;',
  '  letter-spacing: 0.5px;',
  '  font-size: 18px !important;',
  '}',
  '',
  '/* 星空层 */',
  '.rm-panel::before {',
  "  content: ''; position: absolute; inset: 0; z-index: 0; pointer-events: none;",
  '  background-image:',
  '    radial-gradient(1.5px 1.5px at 10% 15%, rgba(80,140,220,0.6) 50%, transparent 100%),',
  '    radial-gradient(1px 1px at 25% 45%, rgba(100,160,240,0.5) 50%, transparent 100%),',
  '    radial-gradient(2px 2px at 55% 65%, rgba(80,140,220,0.55) 50%, transparent 100%),',
  '    radial-gradient(1px 1px at 70% 30%, rgba(120,180,255,0.45) 50%, transparent 100%);',
  '  animation: twinkle-1 3s ease-in-out infinite;',
  '}',
  '.rm-panel::after {',
  "  content: ''; position: absolute; inset: 0; z-index: 0; pointer-events: none;",
  '  background-image:',
  '    radial-gradient(1.5px 1.5px at 5% 40%, rgba(100,180,220,0.5) 50%, transparent 100%),',
  '    radial-gradient(2px 2px at 45% 20%, rgba(80,160,220,0.55) 50%, transparent 100%),',
  '    radial-gradient(1px 1px at 65% 55%, rgba(100,160,240,0.4) 50%, transparent 100%),',
  '    radial-gradient(1px 1px at 95% 45%, rgba(80,140,220,0.4) 50%, transparent 100%);',
  '  animation: twinkle-2 4s ease-in-out 1.5s infinite;',
  '}',
  '',
  '.rm-messages { position: relative; z-index: 2; }',
  '.rm-messages > * { position: relative; z-index: 2; }',
  '.rm-messages::-webkit-scrollbar { width: 3px; }',
  '.rm-messages::-webkit-scrollbar-thumb { background: rgba(80,140,220,0.3); border-radius: 4px; }',
  '',
  '/* 气泡 */',
  '.rm-bubble-ai {',
  '  background: rgba(255, 255, 255, 0.75) !important; backdrop-filter: blur(10px);',
  '  color: #2a3d5c !important; border: 1px solid rgba(80, 140, 220, 0.2) !important;',
  '  border-radius: 0 24px 0 24px !important;',
  '  box-shadow: 4px 4px 12px rgba(80,140,220,0.1), -2px -2px 8px rgba(255,255,255,0.9) !important;',
  '  position: relative; overflow: visible !important;',
  '}',
  '.rm-bubble-ai::before {',
  "  content: '✦'; position: absolute; left: -14px; top: 4px; font-size: 10px; color: rgba(80,140,220,0.6);",
  '  animation: breathe-star 2.5s ease-in-out infinite; pointer-events: none;',
  '}',
  '.rm-bubble-ai::after {',
  "  content: '✧'; position: absolute; left: -8px; bottom: 2px; font-size: 7px; color: rgba(100,160,240,0.5);",
  '  animation: breathe-star 3.2s ease-in-out 0.8s infinite; pointer-events: none;',
  '}',
  '',
  '.rm-bubble-user {',
  '  background: linear-gradient(135deg, #6ba6d9, #78c4cf) !important; color: #fff !important; border: none !important;',
  '  border-radius: 24px 0 24px 0 !important;',
  '  box-shadow: 0 4px 16px rgba(80,140,220,0.3), inset 0 1px 0 rgba(255,255,255,0.2) !important;',
  '  position: relative; overflow: visible !important;',
  '}',
  '.rm-bubble-user::before {',
  "  content: '✦'; position: absolute; right: -14px; top: 4px; font-size: 10px; color: rgba(100,160,240,0.65);",
  '  animation: breathe-star 2.8s ease-in-out 0.3s infinite; pointer-events: none;',
  '}',
  '.rm-bubble-user::after {',
  "  content: '✧'; position: absolute; right: -9px; bottom: 2px; font-size: 7px; color: rgba(120,180,255,0.5);",
  '  animation: breathe-star 3.5s ease-in-out 1s infinite; pointer-events: none;',
  '}',
  '',
  '/* 时间标签 */',
  '.rm-time-tag, .rm-msg-time {',
  '  background: rgba(80, 140, 220, 0.08) !important; color: rgba(60, 110, 180, 0.7) !important;',
  '  text-shadow: 0 0 6px rgba(80, 140, 220, 0.4), 0 0 12px rgba(80, 140, 220, 0.2) !important;',
  '  box-shadow: 0 0 8px rgba(80, 140, 220, 0.15) !important;',
  '  border: 1px solid rgba(80, 140, 220, 0.1); border-radius: 4px; padding: 2px 8px;',
  '}',
  '',
  '/* 输入区 */',
  '.rm-input-area {',
  '  border-top: 1px solid rgba(80, 140, 220, 0.1);',
  '  position: relative; z-index: 10;',
  '  filter: drop-shadow(0 0 0px transparent);',
  '  transition: filter 0.8s ease-out;',
  '}',
  '.rm-input-area:focus-within {',
  '  animation: input-glow-light 4s ease-in-out infinite;',
  '}',
  '.rm-input-wrap {',
  '  background: rgba(255, 255, 255, 0.6) !important; border: 1px solid rgba(80, 140, 220, 0.15) !important;',
  '  box-shadow: inset 0 2px 6px rgba(80, 140, 220, 0.1) !important; border-radius: 0 !important;',
  '  clip-path: polygon(20px 0, calc(100% - 20px) 0, 100% 50%, calc(100% - 20px) 100%, 20px 100%, 0 50%);',
  '  padding-left: 26px !important; padding-right: 26px !important;',
  '  gap: 12px !important;',
  '}',
  '.rm-input { color: #2a3d5c !important; }',
  '.rm-input::placeholder { color: rgba(80, 140, 220, 0.4) !important; }',
  '',
  '/* 发送/重试按钮 */',
  '.rm-send-btn {',
  '  width: 26px !important; height: 26px !important; min-width: 26px;',
  '  margin: 4px 0 4px 0 !important;',
  '  padding: 0 !important; border-radius: 4px !important;',
  '  transform: rotate(45deg);',
  '  background: linear-gradient(135deg, #6ba6d9, #78c4cf) !important;',
  '  color: #fff !important;',
  '  box-shadow: 0 0 10px rgba(100,160,240,0.3);',
  '  display: flex !important; align-items: center; justify-content: center;',
  '}',
  '.rm-send-btn svg { transform: rotate(-45deg); display: none; }',
  ".rm-send-btn::after { content: '✦'; transform: rotate(-45deg); font-size: 13px; }",
  '',
  '.rm-retry-btn {',
  '  width: 26px !important; height: 26px !important; min-width: 26px;',
  '  margin: 4px 6px 4px 0 !important;',
  '  padding: 0 !important; border-radius: 4px !important;',
  '  transform: rotate(45deg);',
  '  background: linear-gradient(135deg, #5c8bbf, #6ba6d9) !important;',
  '  color: #fff !important;',
  '  box-shadow: 0 0 10px rgba(100,160,240,0.3);',
  '  display: flex !important; align-items: center; justify-content: center;',
  '}',
  '.rm-retry-btn svg { transform: rotate(-45deg); display: none; }',
  ".rm-retry-btn::after { content: '☽'; transform: rotate(-45deg); font-size: 13px; }",
  '',
  '/* 正在输入提示 */',
  '.rm-typing { animation: float-drift 2s ease-in-out infinite; }',
  '.rm-typing-name {',
  '  background: linear-gradient(90deg, #4a8bc2, #5cb8b2);',
  '  -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;',
  '  font-size: 16px !important;',
  '}',
  '.rm-typing-text { font-size: 0; }',
  '.rm-typing-text::after {',
  "  content: '信号链接中...'; font-size: 12px; color: rgba(80, 140, 220, 0.6);",
  '}',
  '',
  '/* ══════════════════════════════',
  '   暗色模式板块',
  '   ══════════════════════════════ */',
  '',
  '.dark-mode .rm-panel {',
  '  background: linear-gradient(170deg, #0a101a 0%, #101826 40%, #152233 100%);',
  '  border-top-color: rgba(100, 160, 255, 0.15);',
  '}',
  '.dark-mode .rm-header { border-bottom-color: rgba(100, 160, 255, 0.1); }',
  '.dark-mode .rm-avatar {',
  '  filter: drop-shadow(0 0 12px rgba(100, 160, 255, 0.9)) !important;',
  '  animation: glow-pulse-dark 3s ease-in-out infinite;',
  '}',
  '.dark-mode .rm-char-name {',
  '  background: linear-gradient(90deg, #8bc2ff, #a0e0e0);',
  '  -webkit-background-clip: text; -webkit-text-fill-color: transparent;',
  '}',
  '',
  '.dark-mode .rm-panel::before {',
  '  background-image:',
  '    radial-gradient(1px 1px at 10% 15%, rgba(200,230,255,0.9) 50%, transparent 100%),',
  '    radial-gradient(1.5px 1.5px at 25% 45%, rgba(150,200,255,0.85) 50%, transparent 100%),',
  '    radial-gradient(2px 2px at 55% 65%, rgba(180,220,255,0.9) 50%, transparent 100%),',
  '    radial-gradient(1px 1px at 70% 30%, rgba(255,255,255,0.8) 50%, transparent 100%);',
  '}',
  '.dark-mode .rm-panel::after {',
  '  background-image:',
  '    radial-gradient(1.5px 1.5px at 5% 40%, rgba(180,240,255,0.8) 50%, transparent 100%),',
  '    radial-gradient(2px 2px at 45% 20%, rgba(150,190,255,0.85) 50%, transparent 100%),',
  '    radial-gradient(1px 1px at 65% 55%, rgba(255,255,255,0.6) 50%, transparent 100%),',
  '    radial-gradient(1px 1px at 95% 45%, rgba(200,230,255,0.8) 50%, transparent 100%);',
  '}',
  '',
  '.dark-mode .rm-bubble-ai {',
  '  background: rgba(15, 25, 40, 0.85) !important; color: #c2d6eb !important;',
  '  border-color: rgba(100, 160, 255, 0.15) !important;',
  '  box-shadow: 0 4px 18px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05) !important;',
  '}',
  '.dark-mode .rm-bubble-ai::before { color: rgba(140,190,255,0.7); }',
  '.dark-mode .rm-bubble-ai::after { color: rgba(160,210,255,0.5); }',
  '',
  '.dark-mode .rm-bubble-user {',
  '  background: linear-gradient(135deg, #386b9e, #478d99) !important; color: #e6f0ff !important;',
  '  box-shadow: 0 4px 20px rgba(56,107,158,0.4), inset 0 1px 0 rgba(255,255,255,0.1) !important;',
  '}',
  '.dark-mode .rm-bubble-user::before { color: rgba(160,210,255,0.7); }',
  '.dark-mode .rm-bubble-user::after { color: rgba(180,230,255,0.5); }',
  '',
  '.dark-mode .rm-time-tag, .dark-mode .rm-msg-time {',
  '  background: rgba(100, 160, 255, 0.1) !important; color: rgba(150, 190, 240, 0.65) !important;',
  '  text-shadow: 0 0 8px rgba(120, 180, 255, 0.6), 0 0 16px rgba(100, 160, 255, 0.3) !important;',
  '  box-shadow: 0 0 10px rgba(100, 160, 255, 0.2) !important; border-color: rgba(100, 160, 255, 0.1);',
  '}',
  '',
  '.dark-mode .rm-input-area { border-top-color: rgba(100, 160, 255, 0.1); }',
  '.dark-mode .rm-input-area:focus-within {',
  '  animation: input-glow-dark 4s ease-in-out infinite;',
  '}',
  '.dark-mode .rm-input-wrap {',
  '  background: rgba(10, 18, 30, 0.65) !important; border-color: rgba(100, 160, 255, 0.2) !important;',
  '  box-shadow: inset 0 2px 8px rgba(0,0,0,0.4) !important;',
  '}',
  '.dark-mode .rm-input { color: #d6e8ff !important; }',
  '.dark-mode .rm-input::placeholder { color: rgba(120, 180, 255, 0.3) !important; }',
  '',
  '.dark-mode .rm-send-btn { background: linear-gradient(135deg, #386b9e, #478d99) !important; }',
  '.dark-mode .rm-retry-btn { background: linear-gradient(135deg, #284b70, #386b9e) !important; }',
  '',
  '.dark-mode .rm-typing-name {',
  '  background: linear-gradient(90deg, #8bc2ff, #a0e0e0);',
  '  -webkit-background-clip: text; -webkit-text-fill-color: transparent;',
  '}',
  ".dark-mode .rm-typing-text::after { color: rgba(160, 210, 255, 0.6); }",
].join('\n');

const BUILTIN_READER_BUBBLE_CSS_PRESETS: ReaderCssPreset[] = [
  {
    id: DEFAULT_NEUMORPHISM_BUBBLE_CSS_PRESET_ID,
    name: '默认',
    css: DEFAULT_NEUMORPHISM_BUBBLE_CSS,
  },
  {
    id: STARRY_DEEP_BLUE_CSS_PRESET_ID,
    name: '星辰深蓝',
    css: STARRY_DEEP_BLUE_CSS,
  },
];

export const DEFAULT_READER_BUBBLE_CSS_PRESETS: ReaderCssPreset[] = BUILTIN_READER_BUBBLE_CSS_PRESETS.map((item) => ({ ...item }));

const BUILTIN_IDS = new Set<string>(BUILTIN_READER_BUBBLE_CSS_PRESETS.map((item) => item.id));

const normalizeReaderCssPreset = (value: unknown): ReaderCssPreset | null => {
  if (!value || typeof value !== 'object') return null;
  const source = value as Partial<ReaderCssPreset>;
  const id = typeof source.id === 'string' ? source.id.trim() : '';
  const name = typeof source.name === 'string' ? source.name.trim() : '';
  const css = typeof source.css === 'string' ? source.css : '';
  if (!id || !name) return null;
  return { id, name, css };
};

export const normalizeReaderBubbleCssPresets = (source: unknown): ReaderCssPreset[] => {
  if (!Array.isArray(source)) return DEFAULT_READER_BUBBLE_CSS_PRESETS.map((item) => ({ ...item }));

  const customPresets: ReaderCssPreset[] = [];
  const seenCustomIds = new Set<string>();

  source.forEach((rawItem) => {
    const preset = normalizeReaderCssPreset(rawItem);
    if (!preset) return;
    if (BUILTIN_IDS.has(preset.id)) return;
    if (REMOVED_PRESET_IDS.has(preset.id)) return;
    if (REMOVED_PRESET_NAMES.has(preset.name)) return;
    if (seenCustomIds.has(preset.id)) return;
    seenCustomIds.add(preset.id);
    customPresets.push(preset);
  });

  return [
    ...BUILTIN_READER_BUBBLE_CSS_PRESETS.map((item) => ({ ...item })),
    ...customPresets.map((item) => ({ ...item })),
  ];
};
